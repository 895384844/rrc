"use strict";!function(){function e(e){if(e&&(this._config={chunkSize:1048576},t(this._config,e),(this._config.aliyunCredential||this._config.stsToken)&&this._config.endpoint)){var o=window.ALY;this._config.stsToken?this.oss=new o.OSS({accessKeyId:this._config.stsToken.Credentials.AccessKeyId,secretAccessKey:this._config.stsToken.Credentials.AccessKeySecret,securityToken:this._config.stsToken.Credentials.SecurityToken,endpoint:this._config.endpoint,apiVersion:"2013-10-15"}):this.oss=new o.OSS({accessKeyId:this._config.aliyunCredential.accessKeyId,secretAccessKey:this._config.aliyunCredential.secretAccessKey,endpoint:this._config.endpoint,apiVersion:"2013-10-15"}),this._uploadInfo={},this._uploadInfo.state=void 0,this._uploadInfo.step=void 0}}var t=function(e,t){for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&t[o]&&(e[o]=t[o])};e.UPLOADSTATE={INIT:"init",UPLOADING:"uploading",COMPLETE:"complete",INTERRUPT:"interrupt"},e.UPLOADSTEP={INIT:"init",PART:"part",COMPLETE:"complete"},e.prototype.init=function(t){var o=t.onerror,s=this._config.errors;t?t.file?t.object?(t.object=t.object.replace(new RegExp("^/"),""),this._callback={},this._callback.onerror=t.onerror,this._callback.oncomplete=t.oncomplete,this._callback.onprogress=t.onprogress,this._uploadInfo.file=t.file,this._uploadInfo.blobSlice=File.prototype.slice||File.prototype.mozSlice||File.prototype.webkitSlice,this._uploadInfo.chunksNum=Math.ceil(t.file.size/this._config.chunkSize),this._uploadInfo.currentChunk=0,this._uploadInfo.uploadId=void 0,this._uploadInfo.type=void 0,this._uploadInfo.multipartMap={Parts:[]},this._uploadInfo.connum=0,this._uploadInfo.object=t.object,this._uploadInfo.headers=t.headers,this._uploadInfo.state=e.UPLOADSTATE.INIT,this._uploadInfo.step=e.UPLOADSTEP.INIT):"function"==typeof t.onerror&&o(s.format(VODUploadError.CODE.EmptyValue,VODUploadError.MESSAGE.EmptyValue,"object")):"function"==typeof t.onerror&&o(s.format(VODUploadError.CODE.EmptyValue,VODUploadError.MESSAGE.EmptyValue,"file")):"function"==typeof o&&o(s.format(VODUploadError.CODE.EmptyValue,VODUploadError.MESSAGE.EmptyValue,"options"))},e.prototype.oncomplete=function(){"function"==typeof this._callback.oncomplete&&this._callback.oncomplete(this._uploadInfo.uploadId)},e.prototype.onprogress=function(){var e=this,t=e._uploadInfo.multipartMap;if("function"==typeof this._callback.onprogress){for(var o=0,s=0;s<t.Parts.length;s++)o+=t.Parts[s].loaded;e._callback.onprogress({loaded:o,total:this._uploadInfo.file.size})}},e.prototype.cancelUpload=function(){this._uploadInfo.state=e.UPLOADSTATE.INTERRUPT},e.prototype.createMultipartUpload=function(){var t=this,o={Bucket:t._config.bucket,Key:t._uploadInfo.object,ContentType:t._uploadInfo.file.type||""};t._uploadInfo.state=e.UPLOADSTATE.START,t.oss.createMultipartUpload(o,function(e,o){t.onCreateMultipartUpload(e,o)})},e.prototype.onCreateMultipartUpload=function(t,o){var s=this;this._uploadInfo.state!=e.UPLOADSTATE.INTERRUPT&&(t?"NetworkingError"==t.code?setTimeout(function(){s.createMultipartUpload()},2e3):s._callback.onerror(t):(s._uploadInfo.uploadId=o.UploadId,s._uploadInfo.step=e.UPLOADSTEP.PART,s.loadChunk()))},e.prototype.uploadPart=function(e){var t=this,o=t._uploadInfo.multipartMap,s={Body:o.Parts[e].data,Bucket:t._config.bucket,Key:t._uploadInfo.object,PartNumber:String(e+1),UploadId:t._uploadInfo.uploadId};t.oss.uploadPart(s,function(o,s){t.onUploadPart(e,o,s)}).on("httpUploadProgress",function(s){o.Parts[e].loaded=s.loaded,t.onprogress()})},e.prototype.onUploadPart=function(t,o,s){var n=this,a=this._uploadInfo,i=n._uploadInfo.multipartMap;if(this._uploadInfo.state!=e.UPLOADSTATE.INTERRUPT)if(o)if("NetworkingError"==o.code)i.Parts[t].loaded=0,setTimeout(function(){n.uploadPart(t)},2e3);else{if(n._uploadInfo.state==e.UPLOADSTATE.INTERRUPT)return;a.state=e.UPLOADSTATE.INTERRUPT,n._callback.onerror(o,s)}else i.Parts[t].ETag=s.ETag,i.Parts[t].loaded=i.Parts[t].data.byteLength,delete i.Parts[t].data,a.currentChunk<a.chunksNum?n.loadChunk():0==n._uploadInfo.connum&&i.Parts.length==a.chunksNum&&(n._uploadInfo.step=e.UPLOADSTEP.COMPLETE,n.completeMultipartUpload())},e.prototype.completeMultipartUpload=function(){var e=this,o=e._uploadInfo.multipartMap;for(var s in o.Parts)o.Parts[s].loaded&&delete o.Parts[s].loaded;var n={Bucket:e._config.bucket,Key:e._uploadInfo.object,CompleteMultipartUpload:o,UploadId:e._uploadInfo.uploadId};t(n,e._uploadInfo.headers),this.oss.completeMultipartUpload(n,function(t,o){e.onMultiUploadComplete(t,o)})},e.prototype.onMultiUploadComplete=function(t,o){var s=this;if(this._uploadInfo.state!=e.UPLOADSTATE.INTERRUPT)if(t){if("function"==typeof s._callback.onerror)return void(t?"NetworkingError"==t.code?setTimeout(function(){s.completeMultipartUpload()},2e3):s._callback.onerror(t):console.log("onMultiUploadComplete: error msg is null."))}else"function"==typeof s._callback.oncomplete&&(s._uploadInfo.state=e.UPLOADSTATE.COMPLETE,s._callback.oncomplete(o))},e.prototype.loadChunk=function(){var e=this,t=e._uploadInfo,o=e._config,s=t.currentChunk,n=new FileReader;n.onload=function(t){e.frOnload(s,t)},n.onerror=function(t){e.frOnerror(s,t)};var a=s*o.chunkSize,i=a+o.chunkSize>=t.file.size?t.file.size:a+o.chunkSize,r=t.blobSlice.call(t.file,a,i);n.readAsArrayBuffer(r),t.currentChunk++},e.prototype.frOnload=function(t,o){var s=this;s._uploadInfo.multipartMap.Parts[t]={data:o.target.result,PartNumber:t+1,loaded:0},this._uploadInfo.state!=e.UPLOADSTATE.INTERRUPT&&s.uploadPart(t)},e.prototype.frOnerror=function(e,t){var o=this,s=o._callback.onerror,n=o._config.errors,a=o._uploadInfo;"function"==typeof s&&s(n.format(n.CODE.ReadFileError,n.MESSAGE.ReadFileError,a.file.name,e))},e.prototype.resumeUploadWithToken=function(t,o,s){var n=this,a=n._uploadInfo.multipartMap;if(n._uploadInfo.state==e.UPLOADSTATE.INTERRUPT){n._config.stsToken.Credentials.AccessKeyId=t,n._config.stsToken.Credentials.AccessKeySecret=o,n._config.stsToken.Credentials.SecurityToken=s;var i=window.ALY;if(n._config.stsToken?n.oss=new i.OSS({accessKeyId:n._config.stsToken.Credentials.AccessKeyId,secretAccessKey:n._config.stsToken.Credentials.AccessKeySecret,securityToken:n._config.stsToken.Credentials.SecurityToken,endpoint:n._config.endpoint,apiVersion:"2013-10-15"}):n.oss=new i.OSS({accessKeyId:n._config.aliyunCredential.accessKeyId,secretAccessKey:n._config.aliyunCredential.secretAccessKey,endpoint:n._config.endpoint,apiVersion:"2013-10-15"}),n._uploadInfo.state=e.UPLOADSTATE.UPLOADING,n._uploadInfo.step==e.UPLOADSTEP.INIT)n.createMultipartUpload();else if(n._uploadInfo.step==e.UPLOADSTEP.PART){for(var r in a.Parts)if(a.Parts[r].data){n.uploadPart(parseInt(r));break}}else n._uploadInfo.step==e.UPLOADSTEP.COMPLETE&&n.completeMultipartUpload()}},e.prototype.resumeUpload=function(){var t=this,o=t._uploadInfo.multipartMap;if(t._uploadInfo.state==e.UPLOADSTATE.INTERRUPT)if(t._uploadInfo.state=e.UPLOADSTATE.UPLOADING,t._uploadInfo.step==e.UPLOADSTEP.INIT)t.createMultipartUpload();else if(t._uploadInfo.step==e.UPLOADSTEP.PART){for(var s in o.Parts)if(o.Parts[s].data){t.uploadPart(parseInt(s));break}}else t._uploadInfo.step==e.UPLOADSTEP.COMPLETE&&t.completeMultipartUpload()},e.prototype.upload=function(){this._uploadInfo.state=e.UPLOADSTATE.START,this.createMultipartUpload()};var o=function(e){this.options=e,this.initialize()};o.UPLOADSTATE={INIT:"Ready",UPLOADING:"Uploading",SUCCESS:"Success",FAIlURE:"Failure",CANCELED:"Canceled",STOPED:"Stoped"},o.VODSTATE={INIT:"Init",START:"Start",STOP:"Stop",FAILURE:"Failure",EXPIRE:"Expire",END:"End"},o.prototype={constructor:o,initialize:function(){this.options.uploadList=[],this.options.oss=new Object,this.options.curIndex=null,this.options.state=o.VODSTATE.INIT},init:function(e,t,s,n){if(s&&!n||!s&&n)return!1;if(e&&!t||!e&&t)return!1;var a=this.options;a.oss.accessKeyId=e,a.oss.accessKeySecret=t,a.oss.securityToken=s,a.oss.expireTime=n;for(var i=0;i<a.uploadList.length;i++)a.uploadList[i].state==o.UPLOADSTATE.FAIlURE&&(a.uploadList[i].state=o.UPLOADSTATE.INIT);return!0},addFile:function(e,t,s,n,a){if(!e)return!1;for(var i=this.options,r=0;r<i.uploadList.length;r++)if(i.uploadList[r].file==e)return!1;var l=new Object;l.file=e,l.endpoint=t,l.bucket=s,l.object=n,l.state=o.UPLOADSTATE.INIT,l.userData=ALY.util.base64.encode(a);var c=this;return l.reload=function(){this.state!=o.UPLOADSTATE.CANCELED&&this.state!=o.UPLOADSTATE.FAIlURE||(this.state=o.UPLOADSTATE.INIT),c.options.curIndex=void 0,c.nextUpload()},l.cancel=function(){c.cancelFile(l.file)},c.options.uploadList.push(l),!0},deleteFile:function(e){return!!this.cancelFile(e)&&(this.options.uploadList.splice(e,1),!0)},cleanList:function(){this.stopUpload(),this.options.uploadList.length=0},cancelFile:function(e){var t=this.options;return!(e<0||e>=t.uploadList.length)&&(e==t.curIndex&&t.uploadList[e].state==o.UPLOADSTATE.UPLOADING?(t.uploadList[e].state=o.UPLOADSTATE.CANCELED,this.options.ossUpload.cancelUpload(),this.nextUpload()):t.uploadList[e].state!=o.UPLOADSTATE.SUCCESS&&(t.uploadList[e].state=o.UPLOADSTATE.CANCELED),!0)},resumeFile:function(e){var t=this.options;return!(e<0||e>=t.uploadList.length)&&(t.uploadList[e].state==o.UPLOADSTATE.CANCELED&&(t.uploadList[e].state=o.UPLOADSTATE.INIT,!0))},listFiles:function(){return this.options.uploadList},startUpload:function(){var t=this.options;if(this.options.state!=o.VODSTATE.START&&this.options.state!=o.VODSTATE.EXPIRE){if(this.options.state==o.VODSTATE.STOP&&t&&t.ossUpload&&null!=t.curIndex&&t.uploadList[t.curIndex]&&t.uploadList[t.curIndex].state==o.UPLOADSTATE.STOPED)return t.uploadList[t.curIndex].state=o.UPLOADSTATE.UPLOADING,t.ossUpload.resumeUpload(),void(this.options.state=o.VODSTATE.START);t.curIndex=null;for(var s=0;s<t.uploadList.length;s++)if(t.uploadList[s].state==o.UPLOADSTATE.INIT){t.curIndex=s;break}if(null!=t.curIndex){var n=t.uploadList[t.curIndex];t.onUploadstarted&&t.onUploadstarted(n),n.state=o.UPLOADSTATE.UPLOADING;var a,i=n.endpoint||"http://oss-cn-hangzhou.aliyuncs.com";a=new e(t.oss.securityToken?{bucket:n.bucket,endpoint:i,chunkSize:1048576,concurrency:1,stsToken:{Credentials:{AccessKeyId:t.oss.accessKeyId,AccessKeySecret:t.oss.accessKeySecret,SecurityToken:t.oss.securityToken}}}:{bucket:n.bucket,endpoint:i,chunkSize:1048576,concurrency:1,aliyunCredential:{accessKeyId:t.oss.accessKeyId,secretAccessKey:t.oss.accessKeySecret}}),t.ossUpload=a;var r=this;a.init({file:n.file,object:n.object,maxRetry:3,onerror:function(e){"SecurityTokenExpired"==e.code||"InvalidAccessKeyId"==e.code&&t.oss.secretToken&&t.oss.secretToken.length>0?(t.state=o.VODSTATE.EXPIRE,t.onUploadTokenExpired&&t.onUploadTokenExpired(r)):(n.state!=o.UPLOADSTATE.CANCELED&&(n.state=o.UPLOADSTATE.FAIlURE,t.onUploadFailed&&e&&e.code&&e.message&&t.onUploadFailed(n,e.code,e.message)),t.state=o.VODSTATE.FAILURE)},oncomplete:function(e){n.state=o.UPLOADSTATE.SUCCESS,t.onUploadSucceed&&t.onUploadSucceed(n),setTimeout(function(){r.nextUpload()},100)},onprogress:function(e){t.onUploadProgress&&t.onUploadProgress(n,e.total,e.loaded)},headers:{Notification:n.userData}}),a.upload(),this.options.state=o.VODSTATE.START}else this.options.state=o.VODSTATE.END}},nextUpload:function(){var t=this.options;if(this.options.state==o.VODSTATE.START){t.curIndex=null;for(var s=0;s<t.uploadList.length;s++)if(t.uploadList[s].state==o.UPLOADSTATE.INIT){t.curIndex=s;break}if(null!=t.curIndex){var n=t.uploadList[t.curIndex];t.onUploadstarted&&t.onUploadstarted(n),n.state=o.UPLOADSTATE.UPLOADING;var a,i=n.endpoint||"http://oss-cn-hangzhou.aliyuncs.com";a=new e(t.oss.securityToken?{bucket:n.bucket,endpoint:i,chunkSize:1048576,concurrency:1,stsToken:{Credentials:{AccessKeyId:t.oss.accessKeyId,AccessKeySecret:t.oss.accessKeySecret,SecurityToken:t.oss.securityToken}}}:{bucket:n.bucket,endpoint:i,chunkSize:1048576,concurrency:1,aliyunCredential:{accessKeyId:t.oss.accessKeyId,secretAccessKey:t.oss.accessKeySecret}}),t.ossUpload=a;var r=this;a.init({file:n.file,object:n.object,maxRetry:3,onerror:function(e){"SecurityTokenExpired"==e.code||"InvalidAccessKeyId"==e.code&&t.oss.secretToken&&t.oss.secretToken.length>0?t.onUploadTokenExpired&&(t.state=o.VODSTATE.EXPIRE,t.onUploadTokenExpired(r)):(n.state!=o.UPLOADSTATE.CANCELED&&(n.state=o.UPLOADSTATE.FAIlURE,t.onUploadFailed&&e&&e.code&&e.message&&t.onUploadFailed(n,e.code,e.message)),t.state=o.VODSTATE.FAILURE)},oncomplete:function(e){n.state=o.UPLOADSTATE.SUCCESS,t.onUploadSucceed&&t.onUploadSucceed(n),setTimeout(function(){r.nextUpload()},100)},onprogress:function(e){t.onUploadProgress&&t.onUploadProgress(n,e.total,e.loaded)},headers:{Notification:n.userData}}),a.upload()}else this.options.state=o.VODSTATE.END}},clear:function(e){for(var t=this.options,s=0,n=0;n<t.uploadList.length;n++)t.uploadList[n].state==o.UPLOADSTATE.SUCCESS&&s++,t.uploadList[n].state==e&&(t.uploadList.splice(n,1),n--);t.onClear&&t.onClear(t.uploadList.length,s)},stopUpload:function(){this.options.state!=o.VODSTATE.START&&this.options.state!=o.VODSTATE.FAILURE||(this.options.ossUpload.cancelUpload(),this.options.state=o.VODSTATE.STOP,this.options.uploadList[this.options.curIndex].state=o.UPLOADSTATE.STOPED)},resumeUploadWithAuth:function(e){var t=this;if(!e)return!1;var o=JSON.parse(ALY.util.base64.decode(e));return!!(o.AccessKeyId&&o.AccessKeySecret&&o.SecurityToken&&o.Expiration)&&t.resumeUploadWithToken(o.AccessKeyId,o.AccessKeySecret,o.SecurityToken,o.Expiration)},resumeUploadWithToken:function(e,t,s,n){var a=this.options;return!!(e&&t&&s&&n)&&(this.options.state==o.VODSTATE.EXPIRE&&(this.init(e,t,s,n),a.ossUpload.resumeUploadWithToken(e,t,s),this.options.state=o.VODSTATE.START,!0))},setUploadAuthAndAddress:function(e,t,o){if(!e||!t||!o)return!1;var s=JSON.parse(ALY.util.base64.decode(t));if(!(s.AccessKeyId&&s.AccessKeySecret&&s.SecurityToken&&s.Expiration))return!1;var n=JSON.parse(ALY.util.base64.decode(o));if(!n.Endpoint||!n.Bucket||!n.FileName)return!1;var a=e;this.options.oss.accessKeyId=s.AccessKeyId,this.options.oss.accessKeySecret=s.AccessKeySecret,this.options.oss.securityToken=s.SecurityToken,this.options.oss.expireTime=s.Expiration,a.endpoint=n.Endpoint,a.bucket=n.Bucket,a.object=n.FileName}},window.VODUpload=o}();