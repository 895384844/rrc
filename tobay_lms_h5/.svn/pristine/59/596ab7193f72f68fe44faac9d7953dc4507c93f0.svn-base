function fileType(e){if(""!==e.value){var t=$(e).parents(".addFile");operationImg(t,e),"IE8"==myBrowser()||"IE9"==myBrowser()||""!==$(e).find("#posterImg").val()&&$(e).find("#posterImg").val("")}}function addImgHtml(e,t){$(e).next("#posterImg").val(t)}function addChapter_fn(e){"200"==e.errCode?($(".ex_adm_paper_head h1").text(e.coursewarename),$("#COURSEWARE_ID").val(e.coursewareId),$("#COURSEWARENAME").val(e.coursewarename),$(".addChapter").addClass("hide"),$(".exambox").removeClass("hide")):"400"==e.errCode?M.dialog1=jqueryAlert({content:"系统错误，请联系管理员",closeTime:1e3,modal:!0}):"340"==e.errCode&&(M.dialog1=jqueryAlert({content:"课件名称已存在名车，请重新填写",closeTime:1e3,modal:!0})),$("#next").removeClass("disabled").removeAttr("disabled").val("下一步")}function delcitem_fn(e){"200"==e.errCode&&console.log("删除章节OK")}function upvideo(e){var t=$("#COURSEWARE_ID").val(),a=$(e).parent().find("input[name='ITEMNAME']").val(),o=$(e).parent().find(".section_title");if(""==a||null==a)return showToolClass(o,"请输入章节名称"),$(e).parent().find("input[name='ITEMNAME']").focus(),!1;resetFrom(),hideToolClass(o),hideAllTooltips();var n=$(e).parents("li").find("input[name='ITEMID']").val(),i=$(e).parent().find("input[name='ITEMNAME']").val();if($("#itemName").val(i),""==n){var s=new Object;s.chaptername=i,s.coursewareId=t,commonParm(s),$.ajax({type:"post",url:InterFace.addcItem,data:JSON.stringify(s),cache:!1,datType:"JSON",contentType:"application/json",crossDomain:1==!document.all,success:function(t){"200"==t.errCode?($("#editChapter").addClass("show"),$(e).parents("li").find('input[name="ITEMID"]').val(t.chapterId),$("#checkItemid").val(t.chapterId)):"400"==t.errCode&&(M.dialog1=jqueryAlert({content:"添加章节系统异常",closeTime:1e3,modal:!0}))},async:!0,error:function(e){if("401"==e.status){addCookie("ajaxF","no",0),M.dialog1=jqueryAlert({content:"登录失效，请重新登录",closeTime:1e3,modal:!0});var t=setTimeout(function(){window.location.href="login.html",clearTimeout(t)},1e3)}}})}else $("#editChapter").addClass("show"),$("#checkItemid").val(n)}function resetFrom(){$("#corName").val(""),$("#corIntroduce").val(""),$("#corseVid").val(""),$(".progress .bar").text("").width("0%"),$("#tpupload").val("");var e=$("#tpupload"),t=e[0];t.outerHTML=t.outerHTML;var a=e.clone();e.before(a),e.remove()}function save(e){var t=$("#paper_sections li").length,a=$("#paper_sections .lesTable tr").length;if(t<1||a<1)M.dialog1=jqueryAlert({content:"请至少添加一个课件一个章节",closeTime:1e3,modal:!0});else{$(e).addClass("disabled").attr("disabled","disabled").text("正在保存..");var o=new Array,n=new Array,i=new Array;$.each($("#paper_sections>li"),function(e,t){var a=$(t).find('input[name="ITEMNAME"]').val();o.push(a);var s=$(t).find('input[name="ITEMID"]').val();n.push(s),$.each($(t).find("tbody tr"),function(e,t){var a=$(t).find('input[name="COURSESORT"]').val();i.push(a)})});var s=JSON.stringify(o),r=JSON.stringify(n),l=JSON.stringify(i),d=$("#COURSEWARE_ID").val(),c=new Object;c.coursewareId=d,c.chapterNameJsonStr=s,c.chapterIdJsonStr=r,c.courseSortJsonStr=l,commonParm(c),jsonAjax(InterFace.updateSort,c,savallfn)}}function savallfn(e){"200"==e.errCode?(queryUpdate(),$("#tjBox").show(),$("#saveAllitem").removeClass("disabled").removeAttr("disabled").text("提交")):"400"==e.errCode&&console.log("排序异常")}function refsh_fn(e){"200"==e.errCode&&($("#uploadAuth").val(e.UploadAuth),uploader.resumeUploadWithAuth(data.UploadAuth))}function changeUpload(e){for(var t='{"Vod":{"UserData":"{"IsShowWaterMark":"false","Priority":"7"}"}}',a=0;a<e.target.files.length;a++){var o=e.target.files[a],n=(new Object,o.name),i=n.lastIndexOf("."),s=n.length,r=n.substring(i,s);if(".mp4"!=r&&".rmvb"!=r&&".avi"!=r&&".ts"!=r)return M.dialog1=jqueryAlert({content:"请选择指定格式的视频",closeTime:1e3,modal:!0}),$("#COURSEADDR").val(""),!1;$("#corseVid").val(n);var l=new Object;l.fileName=n,l.title=n,commonParm(l),$.ajax({type:"post",url:InterFace.getAuth,data:JSON.stringify(l),cache:!1,datType:"JSON",contentType:"application/json",crossDomain:1==!document.all,success:function(o){"200"==o.errCode&&($("#uploadAuth").val(o.uploadAuth),$("#uploadAddress").val(o.uploadAddress),$("#VideoId").val(o.videoId),uploader.init(),uploader.addFile(e.target.files[a],null,null,null,t))},async:!0,error:function(e){if("401"==e.status){addCookie("ajaxF","no",0),M.dialog1=jqueryAlert({content:"登录失效，请重新登录",closeTime:1e3,modal:!0});var t=setTimeout(function(){window.location.href="login.html",clearTimeout(t)},1e3)}}}),uploader.addFile(e.target.files[a],null,null,null,t)}}function start(){var e=!1;if($("#editChapter .form_mpss").each(function(){if(0==(e=validate(this)))return!1}),1==e){var t=$("#checkItemid").val(),a=$("#corName").val(),o=$("#COURSEWARE_ID").val(),n=$("#VideoId").val(),i=new Object;i.chapterId=t,i.coursename=a,i.coursewareId=o,i.videoId=n,commonParm(i),jsonAjax(InterFace.addCoursse,i,cour_fn)}}function cour_fn(e){"200"==e.errCode?uploader.startUpload():"341"==e.errCode&&(M.dialog1=jqueryAlert({content:"同一课件下课程名称不能重复",closeTime:1e3,modal:!0}))}function queryUpdate(){var e=$("#COURSEWARE_ID").val(),t=new Object;t.coursewareId=e,commonParm(t),jsonAjax(InterFace.getItems,t,qyItemfn)}function qyItemfn(e){if("200"==e.errCode){var t="";$.each(e.crCourseware.chapterList,function(e,a){t+='<li><dl class="ex_adm_paper_body_section_dl"><input type="hidden" name="ITEMID" class="ex_txt" value="'+a.chapterId+'"/><dt><span class="section_title"> 章节名称 : <input type="text" name="ITEMNAME" class="ex_txt" value="'+a.chaptername+'" size="50"><button class="ex_btn" type="button" onclick="upvideo(this);">上传视频</button> </span> <span class="section_tools"> <a href="javascript:void(0);" onclick="javascript:tmPaper.removeSection(this);" class="ex_ico_delete ex_position_adjustment">删除</a> </span> <input type="hidden" name="p_section_ids" value="1"></dt><table class="table table-striped table-hover lesTable"><tbody class="ui-sortable">';var o="";a.courseList.length>0&&$.each(a.courseList,function(e,t){if("1"==t.videoStatus)a="上传中";else if("2"==t.videoStatus)a="上传成功";else if("3"==t.videoStatus)var a="上传失败";var n=millsTrans(t.coursedate),i=$.myTime.UnixToDate(t.createtime,!0),s=e+1;o+='<tr><td class="center" style="display:none"><input type="hidden" class="itemid" value="'+t.chapterId+'"><input type="hidden" class="coursename" value="'+t.coursename+'"><input type="hidden" class="courseId" value="'+t.courseId+'"><input type="hidden" name="COURSESORT"  value="'+t.chapterId+"_"+t.courseId+'"></td><td class="center" style="width: 5%;">'+s+'</td><td class="left" style="width: 30%;">'+t.coursename+'</td><td class="center" style="width: 10%;">'+n+'</td><td class="center" style="width: 15%;">'+a+'</td><td class="center" style="width: 30%;">'+i+'</td> <td class="center" style="width: 10%;"><div class="hidden-phone visible-desktop btn-group"><div class="inline position-relative"><a class="caozuo" onclick="openWins(this)">操作</a><ul class="dropdown-menu dropdown-icon-only dropdown-light pull-right dropdown-caret dropdown-close"><li><a href="javascript:void(0);" style="cursor:pointer;"  onclick="edit(this)" class="tooltip-success">编辑</a></li><li><a href="javascript:void(0);" style="cursor:pointer;" title="删除" onclick="del(this)" class="tooltip-error">删除</a></li></ul></div></div></td></tr>'}),t+=o+"</tbody></table></dl></li>"}),$("#paper_sections").html(t),$(".lesTable tbody").sortable(),$(".lesTable tbody").disableSelection()}}function openWins(e){$(e).parent(".position-relative").toggleClass("open"),$(e).parents("tr").siblings("tr").find(".position-relative").removeClass("open")}function del(e){var t=$(e).parents("tr").find(".courseId").val(),a=new Object;a.courseId=t,a.coursename="",a.flag="1",commonParm(a),jsonAjax(InterFace.editCourse,a,delCorFn),$(e).parents("tr").remove()}function delCorFn(e){"200"==e.errCode&&($(".position-relative").removeClass("open"),queryUpdate())}function edit(e){var t=$(e).parents("tr").find(".courseId").val(),a=$(e).parents("tr").find(".coursename").val();$("#editCourse #corName").val(a),$("#checkcorid").val(t),$(".position-relative").removeClass("open"),$("#editCourse").addClass("show")}function stop(){uploader.stopUpload()}function resumeWithToken(){var e=document.getElementById("uploadAuth").value;uploader.resumeUploadWithAuth(e)}function isVodMode(){var e=document.getElementById("uploadAuth").value;return e&&e.length>0}function deleteFile(){if(document.getElementById("deleteIndex").value){var e=document.getElementById("deleteIndex").value;uploader.deleteFile(e)}}function cancelFile(){if(document.getElementById("cancelIndex").value){var e=document.getElementById("cancelIndex").value;uploader.cancelFile(e)}}function resumeFile(){if(document.getElementById("resumeIndex").value){var e=document.getElementById("resumeIndex").value;uploader.resumeFile(e)}}function xh(e){e>100?$(".ok").html("加载完成").fadeIn("slow"):e<=100&&(setTimeout("xh()",100),add(e),e++)}function add(e){$(".tbox");$(".tiao").css("width",e+"%").html(e+"%")}var prwarpH=$(".perWrap").height(),ptitH=$(".perWrap_tit").height(),ploadH=prwarpH-ptitH+"px";$(".loadings").css({height:ploadH,"line-height":ploadH}).show(),alertHide();var M={},version=getVersion();pdUserLogin();var colt=new Object;colt.page=1,colt.rows=4,commonParm(colt),$(document).attr("title","上传_人人创培训监管服务平台"),"IE8"==myBrowser()||"IE9"==myBrowser()?($("#mpss_no").removeClass("show"),$("#mpss_ie").addClass("show"),$("#mpss_ie .form_v").on("blur",function(){validate(this)})):($("#mpss_ie").removeClass("show"),$("#mpss_no").addClass("show"),$("#mpss_no .form_v").on("blur",function(){validate(this)})),$("#next").unbind("click").bind("click",function(){var e=$(".show #chapterName").val(),t=$(".show #posterImg").val().split("base64,")[1],a=$(".show #corseType").val(),o=$(".show #corseIntroduce").val(),n=new Object;n.best="2",n.coursewarename=e,n.coursewareurl=t,n.imgStr=a,n.introduce=o,n.recommend="2",n.sort="1",commonParm(n);var i=!1;$(".show .form_v").each(function(){if(0==(i=validate(this)))return!1}),1==i&&($("#next").addClass("disabled").attr("disabled","disabled").val("正在保存.."),jsonAjax(InterFace.addChapter,n,addChapter_fn))});var tmPaper={uiInit:function(){$(".ex_adm_questionlist").unbind("sortstop"),$(".ex_adm_questionlist").sortable({connectWith:".ex_adm_questionlist"}).disableSelection(),$(".ex_adm_questionlist").bind("sortstop",function(e,t){var a=t.item.find("input[name^='p_question_ids_']").val();if($("#paper_sections").find("input[value='"+a+"']").length>1)return alert("目标试题已经存在，请不要重复添加"),void t.item.remove();var o=t.item.parent(),n=o.data("sectionid");o.find("input[name^='p_question_scores_']").attr("name","p_question_scores_"+n),o.find("input[name^='p_question_types_']").attr("name","p_question_types_"+n),o.find("input[name^='p_question_ids_']").attr("name","p_question_ids_"+n),o.find("input[name^='p_question_cnts_']").attr("name","p_question_cnts_"+n)}),$(".ex_adm_paper_body_section").sortable({connectWith:".ex_adm_paper_body_section"}).disableSelection(),$(".ex_qscore").unbind("change"),$(".ex_qscore").bind("change",function(){tmPaper.countScore()})},addSection:function(){var_sectionId++;var e=[];e.push("<li>"),e.push(' <dl class="ex_adm_paper_body_section_dl">'),e.push('<input type="hidden" name="ITEMID" class="ex_txt" size="50" />'),e.push("  <dt>"),e.push('    <span class="section_title">'),e.push("      章节名称 : "),e.push('     <input type="text" name="ITEMNAME" class="ex_txt" size="50" />'),e.push("    </span>"),e.push('    <button class="ex_btn" type="button" onclick="upvideo(this)">上传视频</button>'),e.push('    <span class="section_tools">'),e.push('      <a href="javascript:void(0);" onclick="javascript:tmPaper.removeSection(this);" class="ex_ico_delete ex_position_adjustment">删除</a>'),e.push("    </span>"),e.push('    <input type="hidden" name="p_section_ids" value="'+var_sectionId+'" />'),e.push("  </dt>"),e.push(" </dl>"),e.push("</li>"),$("#paper_sections").append(e.join("")),tmPaper.uiInit()},toggleSection:function(e){var t=$(e).parent().parent().parent(),a=$(e).attr("class");t&&(a.indexOf("ex_ico_max")>-1?($(e).removeClass("ex_ico_max"),$(e).addClass("ex_ico_min"),t.children("dd").slideUp()):($(e).removeClass("ex_ico_min"),$(e).addClass("ex_ico_max"),t.children("dd").slideDown()))},removeSection:function(e){var t=$(e).parents(".ex_adm_paper_body_section_dl").find("input[name='ITEMID']").val();if(""!==t){var a=new Object;a.chapterId=t,commonParm(a),jsonAjax(InterFace.delcitem,a,delcitem_fn)}var o=$(e).parents(".ex_adm_paper_body_section_dl").parent();o.is("li")?o.remove():o.parent().remove(),tmPaper.countScore()},expandSection:function(){$(".ex_adm_paper_body_section_dl dd ").slideDown(),$(".ex_ico_min").removeClass("ex_ico_min").addClass("ex_ico_max")},shrinkSection:function(){$(".ex_adm_paper_body_section_dl dd ").slideUp(),$(".ex_ico_max").removeClass("ex_ico_max").addClass("ex_ico_min")},countScore:function(){var e=0,t=0;$(".ex_adm_paper_body_section .ex_qscore").each(function(t,a){var o=parseInt($(this).val());e+=o}),t=Math.ceil(.6*e),$("input[name='p_total_score']").val(e),$("input[name='p_pass_score']").val(t)},removeItem:function(e){var t=$(e).parent().parent().parent().parent();t.is("li")?t.remove():t.parent().remove(),tmPaper.countScore()},submit:function(){}},var_exam_users="0",pager=null,var_sectionId=1;tmPaper.uiInit(),$(function(){$(".lesTable tbody").sortable(),$(".lesTable tbody").disableSelection()}),$("#editChapter .form_mpss").on("blur",function(){validate(this)});var uploader;window.onload=new function(){uploader=new VODUpload({onUploadFailed:function(e,t,a){alert("onUploadFailed: file:"+e.file.name+",code:"+t+", message:"+a)},onUploadSucceed:function(e){$("#videoName").val(e.file.name),$("#btnupload").removeAttr("disabled")},onUploadProgress:function(e,t,a){xh(Math.ceil(100*a/t))},onUploadTokenExpired:function(){if(isVodMode()){var e=new Object;e.VideoId=$("#VideoId").val(),commonParm(e),jsonAjax(InterFace.getAuth,e,refsh_fn)}},onUploadstarted:function(e){if(isVodMode()){var t=document.getElementById("uploadAuth").value,a=document.getElementById("uploadAddress").value;uploader.setUploadAuthAndAddress(e,t,a)}}})},$("#itemSave").on("click",function(){100!==$(".progress .bar").width()/$(".tbox").width()*100?M.dialog1=jqueryAlert({content:"上传还未完成，请稍后",closeTime:1e3,modal:!0}):($(this).parents(".alertBox").hide(),$(this).parents(".alertBox").hasClass("show")&&$(this).parents(".alertBox").removeClass("show"),queryUpdate())}),$("#editSave").on("click",function(){var e=$("#editCourse #corName").val(),t=$("#checkcorid").val(),a=new Object;a.courseId=t,a.coursename=e,a.flag="2",commonParm(a),$.ajax({type:"post",url:InterFace.editCourse,data:JSON.stringify(a),cache:!1,datType:"JSON",contentType:"application/json",crossDomain:1==!document.all,success:function(e){"200"==e.errCode&&(queryUpdate(),$("#editSave").parents(".alertBox2").removeClass("show").hide())},async:!0,error:function(e){if("401"==e.status){addCookie("ajaxF","no",0),M.dialog1=jqueryAlert({content:"登录失效，请重新登录",closeTime:1e3,modal:!0});var t=setTimeout(function(){window.location.href="login.html",clearTimeout(t)},1e3)}}})}),$(".bi_upload").on("click",function(){window.location.href="my.html#/mysort/course",hashPick(),addCookie("upSrc","yes",0)});